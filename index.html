<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DJ Mix Learning System - Spotify Integration</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #1DB954, #4ecdc4, #45b7d1);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Spotify Connection */
        .spotify-section {
            background: rgba(29, 185, 84, 0.1);
            border: 2px solid #1DB954;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            text-align: center;
        }

        .spotify-connected {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .spotify-user {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 20px;
            border-radius: 25px;
        }

        .spotify-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #1DB954;
        }

        /* Track Browser */
        .track-browser {
            display: none;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .track-browser.active {
            display: block;
        }

        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 12px 20px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #4a5568;
            border-radius: 25px;
            color: white;
            font-size: 1em;
        }

        .search-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-chip {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #4a5568;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-chip.active {
            background: rgba(29, 185, 84, 0.2);
            border-color: #1DB954;
        }

        .track-list {
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
        }

        .track-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .track-item:hover {
            background: rgba(29, 185, 84, 0.1);
            transform: translateX(5px);
        }

        .track-item.selected {
            background: rgba(29, 185, 84, 0.2);
            border: 1px solid #1DB954;
        }

        .track-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .track-artwork {
            width: 50px;
            height: 50px;
            border-radius: 5px;
            object-fit: cover;
        }

        .track-details {
            flex: 1;
        }

        .track-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .track-artist {
            color: #888;
            font-size: 0.9em;
        }

        .track-features {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .feature-badge {
            padding: 4px 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            font-size: 0.85em;
        }

        .load-deck-btn {
            padding: 8px 16px;
            background: linear-gradient(145deg, #1DB954, #169c46);
            border: none;
            color: white;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .load-deck-btn:hover {
            transform: scale(1.05);
        }

        /* Compatibility Analysis */
        .auto-match {
            background: rgba(78, 205, 196, 0.1);
            border: 2px solid #4ecdc4;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .match-button {
            padding: 12px 30px;
            background: linear-gradient(145deg, #4ecdc4, #45b7d1);
            border: none;
            color: white;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            margin: 10px;
            transition: all 0.3s ease;
        }

        .match-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(78, 205, 196, 0.3);
        }

        /* Status Bar */
        .status-bar {
            display: flex;
            justify-content: space-around;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-led {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff4444;
            animation: pulse 2s infinite;
        }

        .status-led.connected {
            background: #44ff44;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Track Slots */
        .track-slots {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .track-slot {
            background: rgba(255, 255, 255, 0.05);
            border: 2px dashed #4a5568;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            min-height: 150px;
            transition: all 0.3s ease;
        }

        .track-slot.loaded {
            border-color: #44ff44;
            background: rgba(68, 255, 68, 0.05);
        }

        .slot-track {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .slot-artwork {
            width: 80px;
            height: 80px;
            border-radius: 10px;
            object-fit: cover;
        }

        .slot-details {
            flex: 1;
            text-align: left;
        }

        .slot-title {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .slot-features {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        /* Practice Interface */
        .practice-interface {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            display: none;
        }

        .practice-interface.active {
            display: block;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .action-btn {
            background: linear-gradient(145deg, #4a5568, #2d3748);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .action-btn.primary {
            background: linear-gradient(145deg, #4ecdc4, #45b7d1);
        }

        .action-btn.spotify {
            background: linear-gradient(145deg, #1DB954, #169c46);
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Console */
        .console {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .console-line {
            margin-bottom: 5px;
        }

        .console-line.error { color: #ff6b6b; }
        .console-line.success { color: #44ff44; }
        .console-line.info { color: #4ecdc4; }
        .console-line.warning { color: #ffaa00; }
        .console-line.spotify { color: #1DB954; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>DJ Mix Learning System</h1>
            <p>Powered by Spotify • Learn with your favorite tracks</p>
        </div>

        <!-- Spotify Connection -->
        <div class="spotify-section">
            <div id="spotifyStatus">
                <h3>🎵 Connect Your Spotify Account</h3>
                <p>Access millions of tracks and get professional audio analysis</p>
                <button class="action-btn spotify" onclick="connectSpotify()">
                    Connect to Spotify
                </button>
            </div>
            <div id="spotifyConnected" style="display: none;">
                <div class="spotify-connected">
                    <div class="spotify-user">
                        <img id="userAvatar" class="spotify-avatar" src="">
                        <span id="userName"></span>
                    </div>
                    <button class="action-btn" onclick="disconnectSpotify()">Disconnect</button>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-item">
                <div class="status-led" id="spotifyLed"></div>
                <span>Spotify</span>
            </div>
            <div class="status-item">
                <div class="status-led" id="midiStatus"></div>
                <span>MIDI Controller</span>
            </div>
            <div class="status-item">
                <div class="status-led" id="audioStatus"></div>
                <span>Audio Engine</span>
            </div>
        </div>

        <!-- Track Browser -->
        <div class="track-browser" id="trackBrowser">
            <h3>Find Practice Tracks</h3>
            
            <div class="search-bar">
                <input type="text" class="search-input" id="searchInput" 
                       placeholder="Search songs, artists, or paste Spotify URL...">
                <button class="action-btn spotify" onclick="searchTracks()">Search</button>
            </div>
            
            <div class="search-filters">
                <div class="filter-chip" onclick="setGenreFilter('house')">House</div>
                <div class="filter-chip" onclick="setGenreFilter('techno')">Techno</div>
                <div class="filter-chip" onclick="setGenreFilter('dnb')">Drum & Bass</div>
                <div class="filter-chip" onclick="setBPMFilter('120-130')">120-130 BPM</div>
                <div class="filter-chip" onclick="setBPMFilter('140-150')">140-150 BPM</div>
                <div class="filter-chip" onclick="setBPMFilter('170-180')">170-180 BPM</div>
            </div>
            
            <div class="track-list" id="trackList">
                <!-- Tracks will be populated here -->
            </div>
            
            <div class="auto-match">
                <h4>Smart Track Matching</h4>
                <p>Let AI find compatible tracks for perfect mixing practice</p>
                <button class="match-button" onclick="findCompatibleTracks()">
                    🤖 Find Compatible Tracks
                </button>
                <button class="match-button" onclick="loadRecommended()">
                    ⭐ Load Recommended Pairs
                </button>
            </div>
        </div>

        <!-- Track Slots -->
        <div class="track-slots">
            <div class="track-slot" id="slotA">
                <h3>🎵 Deck A</h3>
                <p>Select a track from Spotify or drag local file</p>
                <div id="slotAContent"></div>
            </div>
            <div class="track-slot" id="slotB">
                <h3>🎵 Deck B</h3>
                <p>Select a track from Spotify or drag local file</p>
                <div id="slotBContent"></div>
            </div>
        </div>

        <!-- Practice Interface -->
        <div class="practice-interface" id="practiceInterface">
            <h3>Practice Mode</h3>
            <div id="compatibilityCheck"></div>
            <div class="action-buttons">
                <button class="action-btn primary" onclick="startPractice()" id="startBtn">
                    ▶️ Start Practice
                </button>
                <button class="action-btn" onclick="analyzeMix()" id="analyzeBtn">
                    🔬 Analyze Compatibility
                </button>
            </div>
        </div>

        <!-- Console -->
        <div class="console" id="console"></div>
    </div>

    <script>
        // Spotify Configuration
        const SPOTIFY_CLIENT_ID = '4ec2e4c3697f44c2947148bf82bc8416'; // You'll need to register your app
        const REDIRECT_URI = window.location.origin + window.location.pathname;
        const SCOPES = [
            'user-read-private',
            'user-read-email',
            'user-library-read',
            'playlist-read-private',
            'user-top-read'
        ].join(' ');

        // System State
        const DJSystem = {
            spotify: {
                accessToken: null,
                user: null,
                connected: false
            },
            tracks: {
                A: null,
                B: null
            },
            audioContext: null,
            searchResults: [],
            selectedTrack: null
        };

        // Console Logging
        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const line = document.createElement('div');
            line.className = `console-line ${type}`;
            const time = new Date().toLocaleTimeString();
            line.textContent = `[${time}] ${message}`;
            console.appendChild(line);
            console.scrollTop = console.scrollHeight;
        }

        // Spotify Authentication
        function connectSpotify() {
            const authUrl = `https://accounts.spotify.com/authorize?` +
                `client_id=${SPOTIFY_CLIENT_ID}&` +
                `response_type=token&` +
                `redirect_uri=${encodeURIComponent(REDIRECT_URI)}&` +
                `scope=${encodeURIComponent(SCOPES)}`;
            
            window.location.href = authUrl;
        }

        // Check for access token in URL (after redirect)
        function checkSpotifyAuth() {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            const accessToken = params.get('access_token');
            
            if (accessToken) {
                DJSystem.spotify.accessToken = accessToken;
                DJSystem.spotify.connected = true;
                getUserProfile();
                window.history.replaceState({}, document.title, window.location.pathname);
                return true;
            }
            
            // Check localStorage for saved token
            const savedToken = localStorage.getItem('spotify_token');
            if (savedToken) {
                DJSystem.spotify.accessToken = savedToken;
                validateToken();
            }
            
            return false;
        }

        async function getUserProfile() {
            try {
                const response = await fetch('https://api.spotify.com/v1/me', {
                    headers: {
                        'Authorization': `Bearer ${DJSystem.spotify.accessToken}`
                    }
                });
                
                if (response.ok) {
                    const user = await response.json();
                    DJSystem.spotify.user = user;
                    
                    // Update UI
                    document.getElementById('spotifyStatus').style.display = 'none';
                    document.getElementById('spotifyConnected').style.display = 'block';
                    document.getElementById('userName').textContent = user.display_name || user.id;
                    if (user.images && user.images[0]) {
                        document.getElementById('userAvatar').src = user.images[0].url;
                    }
                    document.getElementById('spotifyLed').classList.add('connected');
                    document.getElementById('trackBrowser').classList.add('active');
                    
                    // Save token
                    localStorage.setItem('spotify_token', DJSystem.spotify.accessToken);
                    
                    log(`Connected to Spotify as ${user.display_name}`, 'spotify');
                }
            } catch (error) {
                log(`Spotify connection error: ${error.message}`, 'error');
            }
        }

        async function validateToken() {
            try {
                const response = await fetch('https://api.spotify.com/v1/me', {
                    headers: {
                        'Authorization': `Bearer ${DJSystem.spotify.accessToken}`
                    }
                });
                
                if (response.ok) {
                    DJSystem.spotify.connected = true;
                    getUserProfile();
                } else {
                    localStorage.removeItem('spotify_token');
                    DJSystem.spotify.accessToken = null;
                }
            } catch (error) {
                localStorage.removeItem('spotify_token');
            }
        }

        function disconnectSpotify() {
            DJSystem.spotify.accessToken = null;
            DJSystem.spotify.connected = false;
            DJSystem.spotify.user = null;
            localStorage.removeItem('spotify_token');
            
            document.getElementById('spotifyStatus').style.display = 'block';
            document.getElementById('spotifyConnected').style.display = 'none';
            document.getElementById('spotifyLed').classList.remove('connected');
            document.getElementById('trackBrowser').classList.remove('active');
            
            log('Disconnected from Spotify', 'info');
        }

        // Track Search
        async function searchTracks() {
            const query = document.getElementById('searchInput').value;
            if (!query) return;
            
            log(`Searching for: ${query}`, 'spotify');
            
            try {
                // Check if it's a Spotify URL
                const spotifyUrlMatch = query.match(/spotify\.com\/track\/([a-zA-Z0-9]+)/);
                
                if (spotifyUrlMatch) {
                    // Get specific track
                    const trackId = spotifyUrlMatch[1];
                    const response = await fetch(`https://api.spotify.com/v1/tracks/${trackId}`, {
                        headers: {
                            'Authorization': `Bearer ${DJSystem.spotify.accessToken}`
                        }
                    });
                    const track = await response.json();
                    displayTracks([track]);
                } else {
                    // Regular search
                    const response = await fetch(
                        `https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=20`,
                        {
                            headers: {
                                'Authorization': `Bearer ${DJSystem.spotify.accessToken}`
                            }
                        }
                    );
                    const data = await response.json();
                    displayTracks(data.tracks.items);
                }
                
                // Get audio features for tracks
                await getAudioFeatures();
                
            } catch (error) {
                log(`Search error: ${error.message}`, 'error');
            }
        }

        async function getAudioFeatures() {
            if (DJSystem.searchResults.length === 0) return;
            
            const trackIds = DJSystem.searchResults.map(t => t.id).join(',');
            
            try {
                const response = await fetch(
                    `https://api.spotify.com/v1/audio-features?ids=${trackIds}`,
                    {
                        headers: {
                            'Authorization': `Bearer ${DJSystem.spotify.accessToken}`
                        }
                    }
                );
                
                const data = await response.json();
                
                // Merge audio features with tracks
                DJSystem.searchResults.forEach((track, index) => {
                    if (data.audio_features[index]) {
                        track.features = data.audio_features[index];
                    }
                });
                
                // Re-display with features
                displayTracks(DJSystem.searchResults);
                
            } catch (error) {
                log(`Failed to get audio features: ${error.message}`, 'error');
            }
        }

        function displayTracks(tracks) {
            DJSystem.searchResults = tracks;
            const trackList = document.getElementById('trackList');
            trackList.innerHTML = '';
            
            tracks.forEach(track => {
                const trackElement = document.createElement('div');
                trackElement.className = 'track-item';
                trackElement.onclick = () => selectTrack(track);
                
                const bpm = track.features ? Math.round(track.features.tempo) : '--';
                const key = track.features ? getKeyName(track.features.key, track.features.mode) : '--';
                const energy = track.features ? Math.round(track.features.energy * 10) : '--';
                
                trackElement.innerHTML = `
                    <div class="track-info">
                        <img class="track-artwork" src="${track.album.images[2]?.url || ''}" alt="">
                        <div class="track-details">
                            <div class="track-title">${track.name}</div>
                            <div class="track-artist">${track.artists.map(a => a.name).join(', ')}</div>
                        </div>
                    </div>
                    <div class="track-features">
                        <span class="feature-badge">${bpm} BPM</span>
                        <span class="feature-badge">${key}</span>
                        <span class="feature-badge">E:${energy}</span>
                        <button class="load-deck-btn" onclick="loadToDeck(event, '${track.id}', 'A')">→ A</button>
                        <button class="load-deck-btn" onclick="loadToDeck(event, '${track.id}', 'B')">→ B</button>
                    </div>
                `;
                
                trackList.appendChild(trackElement);
            });
            
            log(`Found ${tracks.length} tracks`, 'success');
        }

        function getKeyName(key, mode) {
            const keys = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            return keys[key] + (mode === 1 ? '' : 'm');
        }

        function selectTrack(track) {
            DJSystem.selectedTrack = track;
            document.querySelectorAll('.track-item').forEach(el => el.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
        }

        async function loadToDeck(event, trackId, deck) {
            event.stopPropagation();
            
            const track = DJSystem.searchResults.find(t => t.id === trackId);
            if (!track) return;
            
            DJSystem.tracks[deck] = track;
            
            // Update UI
            const slot = document.getElementById(`slot${deck}`);
            slot.classList.add('loaded');
            const content = document.getElementById(`slot${deck}Content`);
            
            const bpm = track.features ? Math.round(track.features.tempo) : '--';
            const key = track.features ? getKeyName(track.features.key, track.features.mode) : '--';
            const energy = track.features ? Math.round(track.features.energy * 10) : '--';
            
            content.innerHTML = `
                <div class="slot-track">
                    <img class="slot-artwork" src="${track.album.images[1]?.url || ''}" alt="">
                    <div class="slot-details">
                        <div class="slot-title">${track.name}</div>
                        <div>${track.artists[0].name}</div>
                        <div class="slot-features">
                            <span class="feature-badge">${bpm} BPM</span>
                            <span class="feature-badge">${key}</span>
                            <span class="feature-badge">Energy: ${energy}/10</span>
                        </div>
                    </div>
                </div>
            `;
            
            log(`Loaded "${track.name}" to Deck ${deck}`, 'success');
            
            // Check if both decks loaded
            if (DJSystem.tracks.A && DJSystem.tracks.B) {
                document.getElementById('practiceInterface').classList.add('active');
                analyzeMix();
            }
        }

        async function findCompatibleTracks() {
            if (!DJSystem.tracks.A) {
                log('Load a track to Deck A first', 'warning');
                return;
            }
            
            const trackA = DJSystem.tracks.A;
            if (!trackA.features) {
                log('No audio features available for track A', 'error');
                return;
            }
            
            const targetBPM = trackA.features.tempo;
            const targetKey = trackA.features.key;
            const targetMode = trackA.features.mode;
            
            log(`Finding tracks compatible with ${Math.round(targetBPM)} BPM, ${getKeyName(targetKey, targetMode)}`, 'spotify');
            
            // Search for tracks in similar BPM range
            const bpmMin = targetBPM - 5;
            const bpmMax = targetBPM + 5;
            
            try {
                // Get recommendations based on the track
                const response = await fetch(
                    `https://api.spotify.com/v1/recommendations?` +
                    `seed_tracks=${trackA.id}&` +
                    `target_tempo=${targetBPM}&` +
                    `min_tempo=${bpmMin}&` +
                    `max_tempo=${bpmMax}&` +
                    `limit=20`,
                    {
                        headers: {
                            'Authorization': `Bearer ${DJSystem.spotify.accessToken}`
                        }
                    }
                );
                
                const data = await response.json();
                displayTracks(data.tracks);
                
                // Get audio features for better matching
                await getAudioFeatures();
                
                // Sort by compatibility
                const sortedTracks = DJSystem.searchResults.sort((a, b) => {
                    if (!a.features || !b.features) return 0;
                    
                    const aBPMDiff = Math.abs(a.features.tempo - targetBPM);
                    const bBPMDiff = Math.abs(b.features.tempo - targetBPM);
                    
                    // Check key compatibility (Camelot wheel)
                    const aKeyCompat = isKeyCompatible(
                        {key: targetKey, mode: targetMode},
                        {key: a.features.key, mode: a.features.mode}
                    ) ? 0 : 10;
                    const bKeyCompat = isKeyCompatible(
                        {key: targetKey, mode: targetMode},
                        {key: b.features.key, mode: b.features.mode}
                    ) ? 0 : 10;
                    
                    return (aBPMDiff + aKeyCompat) - (bBPMDiff + bKeyCompat);
                });
                
                displayTracks(sortedTracks);
                log('Tracks sorted by compatibility', 'success');
                
            } catch (error) {
                log(`Failed to find compatible tracks: ${error.message}`, 'error');
            }
        }

        function isKeyCompatible(key1, key2) {
            // Camelot Wheel compatibility
            const camelotWheel = {
                '0,1': '8B',  '0,0': '5A',   // C major, C minor
                '1,1': '3B',  '1,0': '12A',  // C# major, C# minor
                '2,1': '10B', '2,0': '7A',   // D major, D minor
                '3,1': '5B',  '3,0': '2A',   // D# major, D# minor
                '4,1': '12B', '4,0': '9A',   // E major, E minor
                '5,1': '7B',  '5,0': '4A',   // F major, F minor
                '6,1': '2B',  '6,0': '11A',  // F# major, F# minor
                '7,1': '9B',  '7,0': '6A',   // G major, G minor
                '8,1': '4B',  '8,0': '1A',   // G# major, G# minor
                '9,1': '11B', '9,0': '8A',   // A major, A minor
                '10,1': '6B', '10,0': '3A',  // A# major, A# minor
                '11,1': '1B', '11,0': '10A'  // B major, B minor
            };
            
            const pos1 = camelotWheel[`${key1.key},${key1.mode}`];
            const pos2 = camelotWheel[`${key2.key},${key2.mode}`];
            
            if (!pos1 || !pos2) return false;
            
            // Compatible if same position, +/- 1 number, or same number different letter
            const num1 = parseInt(pos1);
            const num2 = parseInt(pos2);
            const letter1 = pos1.slice(-1);
            const letter2 = pos2.slice(-1);
            
            if (pos1 === pos2) return true;
            if (Math.abs(num1 - num2) === 1 && letter1 === letter2) return true;
            if (num1 === num2) return true;
            if ((num1 === 12 && num2 === 1) || (num1 === 1 && num2 === 12)) return true;
            
            return false;
        }

        async function loadRecommended() {
            log('Loading recommended practice pairs...', 'spotify');
            
            try {
                // Get popular electronic/dance tracks
                const response = await fetch(
                    `https://api.spotify.com/v1/search?q=genre:house%20year:2020-2024&type=track&limit=50`,
                    {
                        headers: {
                            'Authorization': `Bearer ${DJSystem.spotify.accessToken}`
                        }
                    }
                );
                
                const data = await response.json();
                const tracks = data.tracks.items;
                
                // Get audio features
                const trackIds = tracks.map(t => t.id).join(',');
                const featuresResponse = await fetch(
                    `https://api.spotify.com/v1/audio-features?ids=${trackIds}`,
                    {
                        headers: {
                            'Authorization': `Bearer ${DJSystem.spotify.accessToken}`
                        }
                    }
                );
                
                const featuresData = await featuresResponse.json();
                
                // Find compatible pairs
                const pairs = [];
                for (let i = 0; i < tracks.length - 1; i++) {
                    for (let j = i + 1; j < tracks.length; j++) {
                        const features1 = featuresData.audio_features[i];
                        const features2 = featuresData.audio_features[j];
                        
                        if (!features1 || !features2) continue;
                        
                        const bpmDiff = Math.abs(features1.tempo - features2.tempo);
                        const keyCompat = isKeyCompatible(
                            {key: features1.key, mode: features1.mode},
                            {key: features2.key, mode: features2.mode}
                        );
                        
                        if (bpmDiff <= 3 && keyCompat) {
                            pairs.push({
                                track1: {...tracks[i], features: features1},
                                track2: {...tracks[j], features: features2},
                                score: 100 - bpmDiff * 10
                            });
                        }
                    }
                }
                
                if (pairs.length > 0) {
                    // Load best pair
                    const bestPair = pairs.sort((a, b) => b.score - a.score)[0];
                    DJSystem.tracks.A = bestPair.track1;
                    DJSystem.tracks.B = bestPair.track2;
                    
                    // Update UI
                    loadToDeck({stopPropagation: () => {}}, bestPair.track1.id, 'A');
                    loadToDeck({stopPropagation: () => {}}, bestPair.track2.id, 'B');
                    
                    log(`Loaded compatible pair with ${bestPair.score}% match score`, 'success');
                } else {
                    log('No perfect pairs found in current selection', 'warning');
                }
                
            } catch (error) {
                log(`Failed to load recommendations: ${error.message}`, 'error');
            }
        }

        function analyzeMix() {
            if (!DJSystem.tracks.A || !DJSystem.tracks.B) {
                log('Load tracks to both decks first', 'warning');
                return;
            }
            
            const trackA = DJSystem.tracks.A;
            const trackB = DJSystem.tracks.B;
            
            if (!trackA.features || !trackB.features) {
                log('Audio features not available', 'error');
                return;
            }
            
            // Calculate compatibility
            const bpmDiff = Math.abs(trackA.features.tempo - trackB.features.tempo);
            const keyCompat = isKeyCompatible(
                {key: trackA.features.key, mode: trackA.features.mode},
                {key: trackB.features.key, mode: trackB.features.mode}
            );
            const energyDiff = Math.abs(trackA.features.energy - trackB.features.energy);
            
            let score = 100;
            score -= bpmDiff * 5;
            score -= keyCompat ? 0 : 30;
            score -= energyDiff * 20;
            score = Math.max(0, Math.min(100, score));
            
            // Display results
            const compatDiv = document.getElementById('compatibilityCheck');
            compatDiv.innerHTML = `
                <div style="text-align: center; padding: 20px; background: rgba(0,0,0,0.3); border-radius: 10px;">
                    <h3 style="color: ${score > 70 ? '#44ff44' : score > 40 ? '#ffaa00' : '#ff4444'}">
                        Compatibility: ${Math.round(score)}%
                    </h3>
                    <p>BPM Difference: ${bpmDiff.toFixed(1)} BPM</p>
                    <p>Key Match: ${keyCompat ? '✅ Compatible' : '⚠️ May clash'}</p>
                    <p>Energy Match: ${energyDiff < 0.2 ? 'Well matched' : 'Different vibes'}</p>
                    ${score < 50 ? '<p style="color: #ffaa00;">⚠️ This will be a challenging mix</p>' : ''}
                </div>
            `;
            
            document.getElementById('startBtn').disabled = false;
            
            log(`Mix compatibility: ${Math.round(score)}%`, score > 70 ? 'success' : 'warning');
        }

        async function startPractice() {
            if (!DJSystem.tracks.A || !DJSystem.tracks.B) {
                log('Load both tracks first', 'error');
                return;
            }
            
            // For practice, we'll use the preview URLs (30-second clips)
            // In a real implementation, you'd need Spotify Web Playback SDK for full tracks
            
            if (DJSystem.tracks.A.preview_url && DJSystem.tracks.B.preview_url) {
                log('Starting practice with preview clips', 'info');
                log('Note: Using 30-second preview clips. Full tracks require Spotify Premium + Web Playback SDK', 'warning');
                
                // Initialize audio context if needed
                if (!DJSystem.audioContext) {
                    DJSystem.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    document.getElementById('audioStatus').classList.add('connected');
                }
                
                // Here you would implement the practice session
                // This would involve playing the preview URLs and syncing with MIDI controls
                
            } else {
                log('Preview URLs not available for these tracks', 'error');
                log('Try selecting different tracks or use local files', 'info');
            }
        }

        // Genre and BPM Filters
        function setGenreFilter(genre) {
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            event.target.classList.add('active');
            
            const searchInput = document.getElementById('searchInput');
            searchInput.value = `genre:${genre}`;
            searchTracks();
        }

        function setBPMFilter(range) {
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            event.target.classList.add('active');
            
            const [min, max] = range.split('-');
            log(`Filtering tracks ${min}-${max} BPM`, 'info');
            
            // Filter current results by BPM
            if (DJSystem.searchResults.length > 0) {
                const filtered = DJSystem.searchResults.filter(track => {
                    if (!track.features) return false;
                    const bpm = track.features.tempo;
                    return bpm >= parseInt(min) && bpm <= parseInt(max);
                });
                displayTracks(filtered);
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            log('DJ Mix Learning System with Spotify Integration', 'info');
            log('Note: You need to register your app at https://developer.spotify.com', 'warning');
            log('Set your Client ID in the code to enable Spotify features', 'warning');
            
            // Check for Spotify auth
            checkSpotifyAuth();
            
            // Initialize audio context
            document.addEventListener('click', () => {
                if (!DJSystem.audioContext) {
                    DJSystem.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    document.getElementById('audioStatus').classList.add('connected');
                }
            }, { once: true });
        });
    </script>
</body>
</html>
